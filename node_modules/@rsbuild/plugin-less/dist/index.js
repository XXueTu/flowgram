import * as __WEBPACK_EXTERNAL_MODULE_node_path_c5b9b54f__ from "node:path";
import * as __WEBPACK_EXTERNAL_MODULE_node_url_e96de089__ from "node:url";
import * as __WEBPACK_EXTERNAL_MODULE_deepmerge__ from "deepmerge";
import * as __WEBPACK_EXTERNAL_MODULE_reduce_configs_02786df6__ from "reduce-configs";
let src_dirname = __WEBPACK_EXTERNAL_MODULE_node_path_c5b9b54f__.default.dirname((0, __WEBPACK_EXTERNAL_MODULE_node_url_e96de089__.fileURLToPath)(import.meta.url)), isPlainObject = (obj)=>null !== obj && 'object' == typeof obj && Object.getPrototypeOf(obj) === Object.prototype, PLUGIN_LESS_NAME = 'rsbuild:less', getLessLoaderOptions = (userOptions, isUseCssSourceMap, rootPath)=>{
    let excludes = [], defaultLessLoaderOptions = {
        lessOptions: {
            javascriptEnabled: !0,
            paths: [
                __WEBPACK_EXTERNAL_MODULE_node_path_c5b9b54f__.default.join(rootPath, 'node_modules')
            ]
        },
        sourceMap: isUseCssSourceMap,
        implementation: __WEBPACK_EXTERNAL_MODULE_node_path_c5b9b54f__.default.join(src_dirname, '../compiled/less/index.js')
    };
    return {
        options: (0, __WEBPACK_EXTERNAL_MODULE_reduce_configs_02786df6__.reduceConfigsWithContext)({
            initial: defaultLessLoaderOptions,
            config: userOptions,
            ctx: {
                addExcludes: (items)=>{
                    excludes.push(...Array.isArray(items) ? items : [
                        items
                    ]);
                }
            },
            mergeFn: (defaults, userOptions)=>({
                    ...defaults,
                    ...userOptions,
                    lessOptions: defaults.lessOptions && userOptions.lessOptions ? (0, __WEBPACK_EXTERNAL_MODULE_deepmerge__.default)(defaults.lessOptions, userOptions.lessOptions, {
                        isMergeableObject: isPlainObject
                    }) : userOptions.lessOptions || defaults.lessOptions
                })
        }),
        excludes
    };
}, findRuleId = (chain, defaultId)=>{
    let id = defaultId, index = 0;
    for(; chain.module.rules.has(id);)id = `${defaultId}-${++index}`;
    return id;
}, pluginLess = (pluginOptions = {})=>({
        name: PLUGIN_LESS_NAME,
        setup (api) {
            let { include = /\.less$/ } = pluginOptions;
            api.modifyBundlerChain(async (chain, { CHAIN_ID, environment })=>{
                var callback;
                let { config } = environment, rule = chain.module.rule(findRuleId(chain, CHAIN_ID.RULE.LESS)).test(include).resourceQuery({
                    not: /raw|inline/
                }).sideEffects(!0).resolve.preferRelative(!0).end(), inlineRule = CHAIN_ID.RULE.CSS_INLINE && chain.module.rules.has(CHAIN_ID.RULE.CSS_INLINE) ? chain.module.rule(findRuleId(chain, CHAIN_ID.RULE.LESS_INLINE)).test(include).resourceQuery(/inline/) : null;
                chain.module.rule(CHAIN_ID.RULE.LESS_RAW).test(include).type('asset/source').resourceQuery(/raw/);
                let { sourceMap } = config.output, { excludes, options } = getLessLoaderOptions(pluginOptions.lessLoaderOptions, 'boolean' == typeof sourceMap ? sourceMap : sourceMap.css, api.context.rootPath), lessLoaderPath = __WEBPACK_EXTERNAL_MODULE_node_path_c5b9b54f__.default.join(src_dirname, '../compiled/less-loader/index.js');
                (callback = (rule, type)=>{
                    for (let item of excludes)rule.exclude.add(item);
                    pluginOptions.exclude && rule.exclude.add(pluginOptions.exclude);
                    let cssRule = chain.module.rules.get('normal' === type ? CHAIN_ID.RULE.CSS : CHAIN_ID.RULE.CSS_INLINE);
                    for (let id of (rule.dependency(cssRule.get('dependency')), Object.keys(cssRule.uses.entries()))){
                        let loader = cssRule.uses.get(id), options = loader.get('options') ?? {}, clonedOptions = (0, __WEBPACK_EXTERNAL_MODULE_deepmerge__.default)({}, options);
                        id === CHAIN_ID.USE.CSS && (clonedOptions.importLoaders += 1), rule.use(id).loader(loader.get('loader')).options(clonedOptions);
                    }
                    rule.use(CHAIN_ID.USE.LESS).loader(lessLoaderPath).options(options);
                })(rule, 'normal'), inlineRule && callback(inlineRule, 'inline');
            });
        }
    });
export { PLUGIN_LESS_NAME, isPlainObject, pluginLess };
